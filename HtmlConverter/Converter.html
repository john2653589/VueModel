<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>

<script src="../Script/jquery/dist/jquery.min.js"></script>
<script src="../Script/Vue/vue.js"></script>
<script src="../Script/VueModel/VueModel.js"></script>

<style>
    .UnSelect > label {
        user-select: none
    }
</style>


<div id="PageContent" class="d-flex flex-column h-100" style="padding-top:10px; padding-left:20px; padding-right:20px;">

    <div class="row">
        <div class="col">
            <div class="row">
                <div class="col-auto">
                    <label>Find Filter</label>
                </div>
            </div>
            <div class="row">
                <div class="col-auto UnSelect">
                    <label><input id="chk.FindFromType" name="FindFrom" type="checkbox" class="align-middle" /> Find From Type</label>
                </div>
            </div>
            <div class="row">
                <div class="col UnSelect">
                    <label><input id="chkall.Find_All" checked type="checkbox" class="align-middle" /> All</label>
                    <label><input id="chk.Find_BLine" type="checkbox" class="align-middle" /> __</label>
                    <label><input id="chk.Find_Txt" type="checkbox" class="align-middle" /> txt.</label>
                    <label><input id="chk.Find_Inp" type="checkbox" class="align-middle" /> inp.</label>
                    <label><input id="chk.Find_Sel" type="checkbox" class="align-middle" /> sel.</label>
                    <label><input id="chk.Find_Chk" type="checkbox" class="align-middle" /> chk.</label>
                    <label><input id="chk.Find_Rad" type="checkbox" class="align-middle" /> rad.</label>
                    <label>
                        <input id="chk.Find_Other" type="checkbox" class="align-middle" /> Other
                        <input id="inp.Find_OtherTxt" />
                    </label>
                </div>
            </div>
            <div class="row">
                <div class="col UnSelect">
                    <label><input id="chk.FindType_Label" type="checkbox" class="align-middle" /> Label</label>
                    <label><input id="chk.FindType_Div" type="checkbox" class="align-middle" /> Div</label>
                    <label><input id="chk.FindType_Input" type="checkbox" class="align-middle" /> Input</label>
                    <label><input id="chk.FindType_Select" type="checkbox" class="align-middle" /> Select</label>
                    <label><input id="chk.FindType_Checkbox" type="checkbox" class="align-middle" /> Checkbox</label>
                    <label><input id="chk.FindType_Radio" type="checkbox" class="align-middle" /> Radio</label>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="row">
                <div class="col-auto">
                    <label>Output Filter</label>
                </div>
            </div>
            <div class="row">
                <div class="col UnSelect">
                    <label>Replace</label>
                    <label><input id="chk.Replace_BLine" type="checkbox" class="align-middle" /> __</label>
                    <label><input id="chk.Replace_Txt" type="checkbox" class="align-middle" /> txt.</label>
                    <label><input id="chk.Replace_Inp" type="checkbox" class="align-middle" /> inp.</label>
                    <label><input id="chk.Replace_Sel" type="checkbox" class="align-middle" /> sel.</label>
                    <label><input id="chk.Replace_Chk" type="checkbox" class="align-middle" /> chk.</label>
                    <label><input id="chk.Replace_Rad" type="checkbox" class="align-middle" /> rad.</label>
                    <label>
                        <input id="chk.ReplaceOther" type="checkbox" class="align-middle" /> Other
                        <input id="inp.ReplaceOtherText" />
                    </label>
                </div>
            </div>
            <div class="row">
                <div class="col-12 UnSelect">
                    <label>Add Front</label>
                    <label><input id="chk.AddFront_BLine" type="checkbox" class="align-middle" /> __</label>
                    <label><input id="chk.AddFront_Txt" type="checkbox" class="align-middle" /> txt.</label>
                    <label><input id="chk.AddFront_Inp" type="checkbox" class="align-middle" /> inp.</label>
                    <label><input id="chk.AddFront_Sel" type="checkbox" class="align-middle" /> sel.</label>
                    <label><input id="chk.AddFront_Chk" type="checkbox" class="align-middle" /> chk.</label>
                    <label><input id="chk.AddFront_Rad" type="checkbox" class="align-middle" /> rad.</label>
                    <label>
                        <input id="chk.AddFrontOther" type="checkbox" class="align-middle" /> Other
                        <input id="inp.AddFrontOtherTxt" />
                    </label>
                </div>
            </div>
            <div class="row">
                <div class="col-12 UnSelect">
                    <label>Add Back</label>
                    <label><input id="chk.AddBack_BLine" type="checkbox" class="align-middle" /> __</label>
                    <label><input id="chk.AddBack_Txt" type="checkbox" class="align-middle" /> txt.</label>
                    <label><input id="chk.AddBack_Inp" type="checkbox" class="align-middle" /> inp.</label>
                    <label><input id="chk.AddBack_Sel" type="checkbox" class="align-middle" /> sel.</label>
                    <label><input id="chk.AddBack_Chk" type="checkbox" class="align-middle" /> chk.</label>
                    <label><input id="chk.AddBack_Rad" type="checkbox" class="align-middle" /> rad.</label>
                    <label>
                        <input id="chk.AddBackOther" type="checkbox" class="align-middle" /> Other
                        <input id="inp.AddBackOtherTxt" />
                    </label>
                </div>
            </div>

        </div>
    </div>

    <div class="d-flex flex-row flex-grow-1">
        <div class="col-6 d-flex flex-column flex-grow-1">
            <textarea id="inp.TxtHtml" class="flex-fill"></textarea>
        </div>
        <div class="col-6" style="overflow: auto;">
            <div class="p-2 row" id="OutputColumn" v-for="Item in Result.FindColumns">
                <label class="col-6">
                    <a v-on:click="GoHtmlPosition(Item.Id)">
                        <span style="color:blue">
                            {{ Item.Type }} >
                        </span>
                        <span>
                            {{ Item.Id }}
                        </span>
                    </a>
                </label>
                <input class="col-6 form-control" v-model="Item.Value" />
            </div>
        </div>
    </div>

    <div class="row p-2">
        <div class="col-12 row justify-content-center">
            <button id="BtnConvertBack" class="btn btn-primary">< Convert Back</button>
        </div>
    </div>
</div>


<script>
    var FindTypeTxt = [
        'label',
        'span',
        'div',
        ':text',
        'select',
        ':checkbox',
        ':radio',
        'table',
    ];
    var Result = { FindColumns: [] };

    // Find Auto Bind Column
    var Model = new VueModel('', {}, {}, 'PageContent')
        .AddAutoBind_CheckboxYesNo()
        .AddAutoBind_CheckboxYesNo('chkall.')
        .AddAutoBind_Input()
        .AddFunction('GoHtmlPosition', (Id) => {
            GoHtmlFromId(Id);
        })
        .AddFunction('AutoRefresh', () => {
            let GetHtml = Model.Result.TxtHtml;
            if (Model.Result.FindTxt || Model.Result.FindInp ||
                Model.Result.FindSel || Model.Result.FindBLine ||
                Model.Result.FindOther)
                Model.Result.FindAll = false;

            FindIdTxt(GetHtml);
        })
        .AddAutoBind_On('chkall.', 'change', () => {
            if (Model.Result.FindAll) {
                Model.Result.FindTxt = false;
                Model.Result.FindInp = false;
                Model.Result.FindSel = false;
                Model.Result.FindBLine = false;
                Model.Result.FindOther = false;
            }
            Model.VueResult.AutoRefresh();
        })
        .AddAutoBind_On('chk.', 'change', undefined, 'AutoRefresh')
        .AddAutoBind_On('inp.', 'change', undefined, 'AutoRefresh')
        .AddV_Button('BtnConvertBack', () => {
            if (confirm('Convert And Save?')) {
                let FindColumns = Model.Result.FindColumns;
                let TxtHtml = Model.Result.TxtHtml;
                for (let Idx in FindColumns) {
                    let Item = FindColumns[Idx];
                    TxtHtml = TxtHtml.replace(Item.Id, Item.Value);
                }
                Model.Result.TxtHtml = TxtHtml;
                Model.VueResult.AutoRefresh();
            }
        })
        .UpdateVueModel(Result)
        .VueInit();

    function FindIdTxt(GetHtml) {
        let FindTxt = [];
        let GetFindChk = [
            Model.Result.FindBLine,
            Model.Result.FindTxt,
            Model.Result.FindInp,
            Model.Result.FindSel,
            Model.Result.FindChk,
            Model.Result.FindRad,
            Model.Result.FindOther,
        ];
        let GetFindKey = [
            '__',
            'txt.',
            'inp.',
            'sel.',
            'chk.',
            'rad.',
            Model.Result.FindOtherTxt,
        ];
        for (let i = 0; i < GetFindChk.length; i++) {
            if (GetFindChk[i])
                FindTxt.push(GetFindKey[i]);
        }

        let ReplaceTxt = [];
        let GetReplaceChk = [
            Model.Result.ReplaceBLine,
            Model.Result.ReplaceTxt,
            Model.Result.ReplaceInp,
            Model.Result.ReplaceSel,
            Model.Result.ReplaceChk,
            Model.Result.ReplaceRad,
            Model.Result.ReplaceOther,
        ];
        let GetReplaceKey = [
            '__',
            'txt.',
            'inp.',
            'sel.',
            'chk.',
            'rad.',
            Model.Result.ReplaceOtherText,
        ];
        for (let i = 0; i < GetReplaceChk.length; i++) {
            if (GetReplaceChk[i])
                ReplaceTxt.push(GetReplaceKey[i]);
        }

        let AddFrontTxt = [];
        let GetAddFrontChk = [
            Model.Result.AddFrontBLine,
            Model.Result.AddFrontTxt,
            Model.Result.AddFrontInp,
            Model.Result.AddFrontSel,
            Model.Result.AddFrontChk,
            Model.Result.AddFrontRad,
            Model.Result.AddFrontOther,
        ];
        let GetAddFrontTxt = [
            '__',
            'txt.',
            'inp.',
            'sel.',
            'chk.',
            'rad.',
            Model.Result.AddFrontOtherTxt,
        ];
        for (let i = 0; i < GetAddFrontChk.length; i++) {
            if (GetAddFrontChk[i])
                AddFrontTxt.push(GetAddFrontTxt[i]);
        }

        let AddBackTxt = [];
        let GetAddBackChk = [
            Model.Result.AddBackTxt,
            Model.Result.AddBackInp,
            Model.Result.AddBackSel,
            Model.Result.AddBackChk,
            Model.Result.AddBackRad,
            Model.Result.AddBackOther,
            Model.Result.AddBackBLine,
        ];
        let GetAddBackTxt = [
            'txt.',
            'inp.',
            'sel.',
            'chk.',
            'rad.',
            Model.Result.AddBackOtherTxt,
            '__',
        ];
        for (let i = 0; i < GetAddBackChk.length; i++) {
            if (GetAddBackChk[i])
                AddBackTxt.push(GetAddBackTxt[i]);
        }

        let FindType = [];
        let GetFindTypeChk = [
            Model.Result.FindTypeLabel,
            Model.Result.FindTypeDiv,
            Model.Result.FindTypeInput,
            Model.Result.FindTypeSelect,
            Model.Result.FindTypeCheckbox,
            Model.Result.FindTypeRadio,
        ];
        let GetFindTypeTxt = [
            'label',
            'div',
            'input',
            'select',
            'checkbox',
            'radio',
        ];
        for (let i = 0; i < GetFindTypeChk.length; i++) {
            if (GetFindTypeChk[i])
                FindType.push(GetFindTypeTxt[i]);
        }

        Model.Result.FindColumns = [];
        let SplitId = GetHtml.split('id="');
        for (let Idx = 1; Idx < SplitId.length; Idx++) {
            let Item = SplitId[Idx];

            let IsInclude = Model.Result.FindAll;
            for (let i = 0; i < FindTxt.length; i++) {
                let FindItem = FindTxt[i];
                if (Item.includes(FindItem))
                    IsInclude = true;
            }

            if (!IsInclude)
                continue;

            let Id = Item.split(`"`)[0];

            IsInclude = false;

            let FullDom = GetFullDom(GetHtml, Id);
            let Type = GetDomType(FullDom);
            for (let i = 0; i < FindType.length; i++) {
                if (FindType[i] == Type)
                    IsInclude = true;
            }

            if (Model.Result.FindFromType) {
                if (!IsInclude)
                    continue;
            }

            let Value = Id;
            for (let i = 0; i < ReplaceTxt.length; i++) {
                let ReplaceItem = ReplaceTxt[i];
                Value = Value.replaceAll(ReplaceItem, '');
            }

            if (AddFrontTxt.length > 0)
                Value = `${AddFrontTxt.join('')}${Value}`;

            if (AddBackTxt.length > 0)
                Value = `${Value}${AddBackTxt.join('')}`;

            Model.Result.FindColumns.push({
                Type,
                Id,
                Value,
            });
        }
    }

    function GetFullDom(GetHtml, Id) {

        var IdPosition = GetHtml.indexOf(Id, 0);

        let StartIdx = IdPosition;
        while (true) {
            if (GetHtml[StartIdx] == '<')
                break;
            StartIdx--;
        }

        let EndIdx = IdPosition;
        while (true) {
            if (GetHtml[EndIdx] == '>')
                break;
            EndIdx++;
        }

        let GetDom = GetHtml.substring(StartIdx, EndIdx + 1);
        return GetDom;
    }

    function GetDomType(FullDom) {
        let JObj = $(FullDom);
        
        let Type = [
            'label',
            'span',
            'div',
            'input',
            'select',
            'checkbox',
            'radio',
            'table',
        ];
        for (let i = 0; i < FindTypeTxt.length; i++) {
            if (JObj.is(FindTypeTxt[i]))
                return Type[i];
        }
        return 'none';
    }

    function GoHtmlFromId(Id) {
        let JObj = $("[id='inp.TxtHtml']");

        let GetHtml = JObj.val();
        let GetAllLine = GetHtml.split('\n');
        var IdPosition = GetHtml.indexOf(Id, 0);

        let StartIdx = IdPosition;
        while (true) {
            if (GetHtml[StartIdx] == '<')
                break;
            StartIdx--;
        }

        let EndIdx = IdPosition;
        while (true) {
            if (GetHtml[EndIdx] == '>')
                break;
            EndIdx++;
        }

        let ScrollLineIdx = 0;
        for (let i = 0; i < GetAllLine.length; i++) {
            if (GetAllLine[i].includes(Id)) {
                ScrollLineIdx = i;
                break;
            }
        }
        let LineRate = (ScrollLineIdx / GetAllLine.length);
        let ScrollVal = LineRate * JObj.get(0).scrollHeight;
        //JObj.scrollTop(ScrollVal - 100);
        //JObj.focus();
        JObj.prop('selectionStart', StartIdx);
        JObj.prop('selectionEnd', EndIdx + 1);
    }

</script>